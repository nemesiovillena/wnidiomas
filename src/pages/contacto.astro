---
import MainLayout from '../layouts/MainLayout.astro';
import Section from '../components/ui/Section.astro';
import Container from '../components/ui/Container.astro';
import { getSiteSettings, getPaginaBySlug } from '../lib/payload-local';

const siteSettings = await getSiteSettings();
const pageData = await getPaginaBySlug('contacto');

const pageTitle = pageData?.metaTitle || `Contacto | ${siteSettings?.title || "Warynessy"}`;
const pageDescription = pageData?.metaDescription || "Contacta con nosotros para reservas o consultas.";

const contact = siteSettings?.contact || {
  address: "Isabel la Católica, 13 A, 03400 Villena, Alicante",
  email: "info@warynessy.com",
  phone: "+34 965 80 15 88"
};

// Imagen Hero desde el CMS o fallback
const heroImg = typeof pageData?.heroImage === 'object' && pageData?.heroImage?.url 
  ? pageData.heroImage.url 
  : 'https://images.unsplash.com/photo-1534536281715-3bd66a50689b?auto=format&fit=crop&q=80';
---

<MainLayout title={pageTitle} description={pageDescription} noPaddingTop={true}>
  <section class="relative pt-32 pb-12 md:pt-48 md:pb-16 bg-matte-black overflow-hidden">
     <div class="absolute inset-0 bg-cover bg-center opacity-20" style={`background-image: url('${heroImg}')`}></div>
     <div class="absolute inset-0 bg-gradient-to-t from-matte-black to-transparent"></div>
     <Container class="relative z-10 text-center animate-fade-up">
        <span class="text-primary font-bold tracking-[0.3em] uppercase text-sm mb-4 block">
          {pageData?.heroSubtitle || "Contacto"}
        </span>
        <h1 class="text-5xl md:text-7xl font-display font-black text-white mb-6">
          {pageData?.heroTitle || "Estamos aquí"}
        </h1>
        <p class="text-white/60 text-lg max-w-2xl mx-auto font-light">
          {pageData?.heroSubtitle ? "" : "¿Tienes alguna duda o quieres organizar un evento especial? Contacta con nosotros."}
        </p>
     </Container>
  </section>

  <Section class="bg-matte-black pt-0">
    <Container>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 -mt-16 relative z-20">
        
        {/* Información de contacto */}
        <div class="bg-[#1A1816] p-10 md:p-16 rounded-2xl shadow-2xl border border-white/5 animate-fade-up">
          <h2 class="text-3xl font-serif font-bold text-white mb-10">Datos de Contacto</h2>
          
          <div class="space-y-8">
            <div class="flex gap-6">
              <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                <span class="material-symbols-outlined text-primary">location_on</span>
              </div>
              <div>
                <h3 class="text-white font-bold mb-1">Ubicación</h3>
                <p class="text-white/60">{contact.address}</p>
              </div>
            </div>

            <div class="flex gap-6">
              <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                <span class="material-symbols-outlined text-primary">call</span>
              </div>
              <div>
                <h3 class="text-white font-bold mb-1">Teléfono</h3>
                <a href={`tel:${contact.phone}`} class="text-white/60 hover:text-primary transition-colors" data-track="phone_click" data-track-category="contact_page">{contact.phone}</a>
              </div>
            </div>

            <div class="flex gap-6">
              <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                <span class="material-symbols-outlined text-primary">mail</span>
              </div>
              <div>
                <h3 class="text-white font-bold mb-1">Email</h3>
                <a href={`mailto:${contact.email}`} class="text-white/60 hover:text-primary transition-colors" data-track="email_click" data-track-category="contact_page">{contact.email}</a>
              </div>
            </div>
          </div>

          <div class="mt-12 pt-12 border-t border-white/5">
            <h3 class="text-white font-bold mb-6">Siguenos</h3>
            <div class="flex gap-4">
              {siteSettings?.socialMedia?.instagram && (
                <a href={siteSettings.socialMedia.instagram} target="_blank" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white hover:bg-primary transition-colors">
                   <i class="fab fa-instagram"></i>
                </a>
              )}
              {siteSettings?.socialMedia?.facebook && (
                <a href={siteSettings.socialMedia.facebook} target="_blank" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white hover:bg-primary transition-colors">
                   <i class="fab fa-facebook-f"></i>
                </a>
              )}
            </div>
          </div>
        </div>

        {/* Formulario de contacto */}
        <div class="bg-white p-10 md:p-16 rounded-2xl shadow-2xl animate-fade-up" style="animation-delay: 200ms;">
          <h2 class="text-3xl font-serif font-bold text-gray-900 mb-8">Envíanos un mensaje</h2>

          <form id="contact-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="nombre" class="text-sm font-bold text-gray-500 uppercase tracking-widest">Nombre</label>
                <input id="nombre" name="nombre" type="text" required placeholder="Tu nombre" class="w-full bg-gray-50 border border-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:border-primary transition-colors" />
              </div>
              <div class="space-y-2">
                <label for="email" class="text-sm font-bold text-gray-500 uppercase tracking-widest">Email</label>
                <input id="email" name="email" type="email" required placeholder="tu@email.com" class="w-full bg-gray-50 border border-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:border-primary transition-colors" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="telefono" class="text-sm font-bold text-gray-500 uppercase tracking-widest">Teléfono</label>
                <input id="telefono" name="telefono" type="tel" placeholder="Tu número" class="w-full bg-gray-50 border border-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:border-primary transition-colors" />
              </div>
              <div class="space-y-2">
                <label for="asunto" class="text-sm font-bold text-gray-500 uppercase tracking-widest">Asunto</label>
                <select id="asunto" name="asunto" class="w-full bg-gray-50 border border-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:border-primary transition-colors">
                  <option>Reserva Especial / Evento</option>
                  <option>Sugerencia / Feedback</option>
                  <option>Trabaja con nosotros</option>
                  <option>Otro</option>
                </select>
              </div>
            </div>

            <div class="space-y-2">
              <label for="mensaje" class="text-sm font-bold text-gray-500 uppercase tracking-widest">Mensaje</label>
              <textarea id="mensaje" name="mensaje" rows="4" required placeholder="¿En qué podemos ayudarte?" class="w-full bg-gray-50 border border-gray-100 rounded-lg px-4 py-3 focus:outline-none focus:border-primary transition-colors resize-none"></textarea>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-primary text-white font-bold py-4 px-8 rounded-lg hover:bg-primary/90 transition-colors text-center uppercase tracking-wider">
              Enviar Mensaje
            </button>

            <div id="form-message" class="hidden rounded-lg p-4 text-center text-sm font-medium"></div>
          </form>
        </div>

      </div>
    </Container>
  </Section>

  <script>
    document.addEventListener('astro:page-load', () => {
      const form = document.getElementById('contact-form') as HTMLFormElement | null;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
      const formMessage = document.getElementById('form-message');

      if (!form || !submitBtn || !formMessage) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const nombre = (document.getElementById('nombre') as HTMLInputElement).value.trim();
        const email = (document.getElementById('email') as HTMLInputElement).value.trim();
        const telefono = (document.getElementById('telefono') as HTMLInputElement).value.trim();
        const asunto = (document.getElementById('asunto') as HTMLSelectElement).value;
        const mensaje = (document.getElementById('mensaje') as HTMLTextAreaElement).value.trim();

        if (!nombre || !email || !mensaje) {
          showMessage('Por favor, completa todos los campos obligatorios.', 'error');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        try {
          const response = await fetch('/api/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, email, telefono, asunto, mensaje }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage('Mensaje enviado correctamente. Te responderemos pronto.', 'success');
            form.reset();
            
            // @ts-ignore
            if (typeof window.trackContactSubmit === 'function') {
              // @ts-ignore
              window.trackContactSubmit(asunto);
            } else {
              // Fallback si no está expuesta globalmente, usamos el import si es posible
              const { trackContactSubmit } = await import('../lib/analytics');
              trackContactSubmit(asunto);
            }
          } else {
            showMessage(data.error || 'Error al enviar el mensaje.', 'error');
          }
        } catch {
          showMessage('Error de conexión. Inténtalo de nuevo.', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar Mensaje';
        }
      });

      function showMessage(text: string, type: 'success' | 'error') {
        if (!formMessage) return;
        formMessage.textContent = text;
        formMessage.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
        if (type === 'success') {
          formMessage.classList.add('bg-green-50', 'text-green-700');
        } else {
          formMessage.classList.add('bg-red-50', 'text-red-700');
        }
        formMessage.classList.remove('hidden');
      }
    });
  </script>

  {/* Información adicional: Horarios, Cómo llegar, Parking */}
  <Section class="bg-matte-black">
    <Container>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

        {/* Horarios */}
        <div class="bg-white/5 p-8 rounded-2xl border border-white/10">
          <div class="flex items-center gap-4 mb-6">
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="material-symbols-outlined text-primary">schedule</span>
            </div>
            <h3 class="text-white font-serif text-xl font-bold">Horarios</h3>
          </div>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-white/60">Lunes</span>
              <span class="text-white">Cerrado</span>
            </div>
            <div class="flex justify-between">
              <span class="text-white/60">Martes - Viernes</span>
              <span class="text-white">13:30 - 16:00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-white/60">Viernes - Sábado</span>
              <span class="text-white">20:30 - 23:30</span>
            </div>
            <div class="flex justify-between">
              <span class="text-white/60">Domingo</span>
              <span class="text-white">13:30 - 16:00</span>
            </div>
            <p class="text-white/40 text-xs mt-4 pt-4 border-t border-white/10">
              * Horarios orientativos. Pueden variar en festivos.
            </p>
          </div>
        </div>

        {/* Cómo llegar */}
        <div class="bg-white/5 p-8 rounded-2xl border border-white/10">
          <div class="flex items-center gap-4 mb-6">
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="material-symbols-outlined text-primary">directions</span>
            </div>
            <h3 class="text-white font-serif text-xl font-bold">Cómo llegar</h3>
          </div>
          <div class="space-y-4 text-sm text-white/60">
            <div>
              <span class="text-white font-medium block mb-1">En coche</span>
              <p>Desde la A-31, toma la salida 195 hacia Villena centro. Nos encontramos al lado del parque Ruperto Chapí.</p>
            </div>
            <div>
              <span class="text-white font-medium block mb-1">En tren</span>
              <p>Estación de Villena a 2 minutos andando. Líneas Cercanías C-3 desde Alicante y Valencia.</p>
            </div>

          </div>
        </div>

        {/* Parking y accesibilidad */}
        <div class="bg-white/5 p-8 rounded-2xl border border-white/10">
          <div class="flex items-center gap-4 mb-6">
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="material-symbols-outlined text-primary">local_parking</span>
            </div>
            <h3 class="text-white font-serif text-xl font-bold">Aparcamiento</h3>
          </div>
          <div class="space-y-4 text-sm text-white/60">
            <div>
              <span class="text-white font-medium block mb-1">Aparcamiento</span>
              <p>Zona azul en calles adyacentes.</p>
              <p>Aparcamiento libre calle Cristobal Amorós (2 min andando).</p>
              <p>Aparcamiento libre calle Ronda Estación (2 min andando)</p>
              <p>Aparcamiento libre zona Policía Municipal (5 min andando).</p>
            </div>
          </div>
        </div>

      </div>
    </Container>
  </Section>

  {/* Mapa */}
  <section class="h-[500px] w-full bg-zinc-900 grayscale hover:grayscale-0 transition-all duration-700">
     <iframe
      src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d194.79878719413762!2d-0.8633355120511953!3d38.63092819999999!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd63df750f84752f%3A0x4b23cbcf13f8d65a!2sC.%20de%20Isabel%20la%20Cat%C3%B3lica%2C%2013%2C%20a%2C%2003400%20Villena%2C%20Alicante!5e0!3m2!1ses!2ses!4v1769468328786!5m2!1ses!2ses"
      width="100%"
      height="100%"
      style="border:0;"
      allowfullscreen=""
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade"
    ></iframe>
  </section>
</MainLayout>
