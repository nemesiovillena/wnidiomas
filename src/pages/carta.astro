---
import MainLayout from '../layouts/MainLayout.astro';
import Section from '../components/ui/Section.astro';
import Container from '../components/ui/Container.astro';
import CategorySection from '../components/content/CategorySection.astro';
import { getSiteSettings, getCategorias, getPlatos } from '../lib/payload-local';

const siteSettings = await getSiteSettings();
const allCategories = await getCategorias();
const allDishes = await getPlatos();

const categoriesWithDishes = allCategories.map((cat: any) => ({
  ...cat,
  platos: allDishes.filter((dish: any) => 
     dish.categoria === cat.id || dish.categoria?.id === cat.id
  )
}));

// Filter out categories without dishes to keep it clean, if desired. 
// Or keep them to show "Coming soon". Let's keep empty ones for now but maybe filtered in UI if needed.
const activeCategories = categoriesWithDishes.filter((cat: any) => cat.activa);

const pageTitle = `Carta | ${siteSettings?.title || "Warynessy"}`;
const pageDescription = "Descubre nuestra exquisita selección de platos, elaborados con productos locales y de temporada.";
---

<MainLayout title={pageTitle} description={pageDescription}>
  
  {/* Header Hero for Menu */}
  <section class="relative py-32 bg-matte-black overflow-hidden">
     <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1559339352-11d035aa65de?auto=format&fit=crop&q=80')] bg-cover bg-center opacity-20"></div>
     <div class="absolute inset-0 bg-gradient-to-t from-matte-black to-transparent"></div>
     <Container class="relative z-10 text-center animate-fade-up">
        <span class="text-primary font-bold tracking-[0.3em] uppercase text-sm mb-4 block">Gastronomía</span>
        <h1 class="text-5xl md:text-7xl font-display font-black text-white mb-6">Nuestra Carta</h1>
        <p class="text-white/60 text-lg max-w-2xl mx-auto font-light">
          Una propuesta culinaria que fusiona la tradición mediterránea con técnicas contemporáneas y los mejores productos de mercado.
        </p>
     </Container>
  </section>

  <Section class="bg-matte-black min-h-screen relative">
    <Container>
      <div class="flex flex-col lg:flex-row gap-12">
        
        {/* Sidebar Navigation (Desktop) */}
        <aside class="hidden lg:block w-1/4 relative">
          <div class="sticky top-32">
             <h3 class="text-white font-bold uppercase tracking-widest mb-6 border-b border-primary/30 pb-2">Categorías</h3>
             <nav class="flex flex-col gap-2">
               {activeCategories.map((cat: any) => (
                 <a 
                   href={`#${cat.slug}`} 
                   class="text-white/60 hover:text-primary transition-colors py-2 text-sm font-medium border-l-2 border-transparent hover:border-primary pl-4 -ml-[2px]"
                 >
                   {cat.nombre}
                 </a>
               ))}
             </nav>
          </div>
        </aside>

        {/* Mobile Filter Pills */}
        <div class="lg:hidden flex overflow-x-auto gap-4 pb-4 mb-8 sticky top-20 z-40 bg-matte-black/95 backdrop-blur py-4 -mx-6 px-6 border-b border-white/5">
           {activeCategories.map((cat: any) => (
             <a 
               href={`#${cat.slug}`} 
               class="whitespace-nowrap px-6 py-2 rounded-full border border-white/20 text-white/80 text-sm font-medium active:bg-primary active:text-white active:border-primary"
             >
               {cat.nombre}
             </a>
           ))}
        </div>

        {/* Main Content */}
        <div class="w-full lg:w-3/4">
           {activeCategories.map((cat: any) => (
             <CategorySection category={cat} dishes={cat.platos} />
           ))}
        </div>

      </div>
    </Container>
  </Section>

</MainLayout>
