---
import MainLayout from '../layouts/MainLayout.astro';
import Section from '../components/ui/Section.astro';
import Container from '../components/ui/Container.astro';
import DishListItem from '../components/content/DishListItem.astro';
import DishCard from '../components/content/DishCard.astro';
import { getSiteSettings, getCategorias, getPlatos, getAlergenos, getPaginaBySlug } from '../lib/payload-local';
import fs from 'node:fs';
import path from 'node:path';

const siteSettings = await getSiteSettings();
const allCategories = await getCategorias();
const allDishes = await getPlatos();
const allAlergenos = await getAlergenos();

const pageData = await getPaginaBySlug('carta');

// Image mapping logic
const imagesBaseDir = path.resolve('public/images/carta');
const imageCategories: Record<string, string> = {
  'vinos': 'vinos',
  'espumosos-y-vinos-dulces': 'espumosos',
  'vermut-y-cervezas': 'vermuts'
};

const availableImages = new Map<string, string[]>();

if (fs.existsSync(imagesBaseDir)) {
  Object.entries(imageCategories).forEach(([slug, dirName]) => {
    const dirPath = path.join(imagesBaseDir, dirName);
    if (fs.existsSync(dirPath)) {
      availableImages.set(slug, fs.readdirSync(dirPath));
    }
  });
}

function getLocalImageForDish(dishName: string, categorySlug: string): string | null {
  // Only look for images for specific categories
  const dirName = imageCategories[categorySlug];
  if (!dirName) return null;

  const files = availableImages.get(categorySlug) || [];
  
  // Normalize dish name to match filename format (remove non-ascii, snake_case)
  // Observation: "Marqués" -> "marqus" (accented char dropped), "Paco & Lola" -> "paco__lola" (spaces preserved as underscores)
  const normalized = dishName.toLowerCase()
    .replace(/[^a-z0-9\s]/g, "") // remove ANY non-alphanumeric chars (including accents)
    .trim()
    .replace(/\s/g, "_"); // replace spaces with underscores (one-to-one)

  // Try to find a file that starts with this normalized name
  const match = files.find(f => f.toLowerCase().startsWith(normalized));
  
  if (match) {
    return `/images/carta/${dirName}/${match}`;
  }
  
  return null;
}

// Add dishes to each category
const categoriesWithDishes = allCategories.map((cat: any) => ({
  ...cat,
  platos: allDishes.filter((dish: any) =>
     dish.categoria === cat.id || dish.categoria?.id === cat.id
  )
}));

// Filter active categories with dishes
const activeCategories = categoriesWithDishes.filter((cat: any) => cat.activa && cat.platos.length > 0);

// Extract main category from name (before " - ")
function getMainCategory(nombre: string): string {
  if (nombre.includes(' - ')) {
    return nombre.split(' - ')[0].trim();
  }
  return nombre;
}

// Extract subcategory from name (after " - ")
function getSubcategory(nombre: string): string | null {
  if (nombre.includes(' - ')) {
    return nombre.split(' - ')[1].trim();
  }
  return null;
}

// Define the order of main categories as they appear on the original site
const mainCategoryOrder = [
  'Aperitivos',
  'Ensaladas',
  'Cuchara',
  'Arroces',
  'Carnes',
  'Pescados',
  'Montaditos y panes',
  'Postres',
  'Vinos',
  'Vermut y Cervezas',
  'Espumosos y vinos dulces'
];

// Group categories by main category name
interface SubcategoryGroup {
  subcategoryName: string | null;
  slug: string;
  descripcion?: string;
  platos: any[];
  orden: number;
}

interface MainCategoryGroup {
  mainName: string;
  slug: string;
  subcategories: SubcategoryGroup[];
}

const groupedCategories = new Map<string, MainCategoryGroup>();

activeCategories.forEach((cat: any) => {
  const mainName = getMainCategory(cat.nombre);
  const subName = getSubcategory(cat.nombre);

  if (!groupedCategories.has(mainName)) {
    // Create slug from main category name
    const mainSlug = mainName.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');

    groupedCategories.set(mainName, {
      mainName,
      slug: mainSlug,
      subcategories: []
    });
  }

  groupedCategories.get(mainName)!.subcategories.push({
    subcategoryName: subName,
    slug: cat.slug,
    descripcion: cat.descripcion,
    platos: cat.platos,
    orden: cat.orden || 999
  });
});

// Sort subcategories within each main category by orden
groupedCategories.forEach((group) => {
  group.subcategories.sort((a, b) => a.orden - b.orden);
});

// Convert to array, filter only categories in the defined order, and sort
const sortedMainCategories = Array.from(groupedCategories.values())
  .filter((cat) => mainCategoryOrder.includes(cat.mainName))
  .sort((a, b) => {
    const indexA = mainCategoryOrder.indexOf(a.mainName);
    const indexB = mainCategoryOrder.indexOf(b.mainName);
    return indexA - indexB;
  });

const pageTitle = pageData?.metaTitle || `Carta | ${siteSettings?.title || "Warynessy"}`;
const pageDescription = pageData?.metaDescription || "Descubre nuestra exquisita selección de platos.";

// Imagen Hero desde el CMS o fallback
const rawHeroImage = typeof pageData?.heroImage === 'object' && pageData?.heroImage?.url
  ? pageData.heroImage.url
  : '/media/Warynessy-carta.webp';

const PAYLOAD_URL = import.meta.env.PAYLOAD_PUBLIC_SERVER_URL || 'http://localhost:3000';
const heroImage = (rawHeroImage.startsWith('/') && !rawHeroImage.startsWith('http'))
  ? `${PAYLOAD_URL}${rawHeroImage}`
  : rawHeroImage;
---

<MainLayout
  title={pageTitle}
  description={pageDescription}
  hideFloatingButton={true}
  schemaType="Menu"
  schemaData={{ name: "Carta Warynessy 2026" }}
>

  {/* Header Hero for Menu */}
  <section class="relative py-24 md:py-32 bg-matte-black overflow-hidden">
     <div class="absolute inset-0 bg-cover bg-center opacity-30" style={`background-image: url('${heroImage}')`}></div>
     <div class="absolute inset-0 bg-gradient-to-t from-matte-black via-matte-black/80 to-transparent"></div>
     <Container class="relative z-10 text-center animate-fade-up">
        <span class="text-primary font-medium tracking-[0.3em] uppercase text-sm mb-4 block">Gastronomía</span>
        <h1 class="text-4xl md:text-6xl font-display font-bold text-white mb-4">Nuestra Carta</h1>
        <p class="text-white/50 text-base max-w-xl mx-auto">
          Cocina mediterránea con los mejores productos de mercado
        </p>
     </Container>
  </section>

  <Section class="bg-matte-black min-h-screen py-12 md:py-16">
    <Container>

      {/* Allergen Filter Bar - Compact */}
      {allAlergenos.length > 0 && (
        <div class="mb-12 animate-fade-up">
          <div class="flex flex-col items-center text-center gap-6">
            <span class="text-primary text-sm uppercase tracking-[0.2em] font-black border-b border-primary/20 pb-2">Filtrar sin:</span>
            
            <div class="flex flex-wrap justify-center gap-4 max-w-5xl">
              {allAlergenos.map((alergeno: any) => {
                const imgUrl = typeof alergeno.imagen === 'object' && alergeno.imagen?.url
                  ? (alergeno.imagen.url.startsWith('/') ? `${PAYLOAD_URL}${alergeno.imagen.url}` : alergeno.imagen.url)
                  : null;

                return (
                  <button
                    class="allergen-filter-btn group flex flex-col items-center gap-2 p-2 rounded-2xl border border-white/5 text-white/50 hover:border-primary/50 hover:text-white transition-all text-sm font-bold tracking-tight w-24"
                    data-alergeno-id={alergeno.id}
                  >
                    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full bg-white/5 flex items-center justify-center p-3 group-hover:bg-primary/20 transition-colors border border-white/10">
                      {imgUrl && (
                        <img src={imgUrl} alt="" class="w-full h-full object-contain group-hover:scale-110 transition-transform opacity-70 group-hover:opacity-100" />
                      )}
                    </div>
                    <span class="text-center leading-tight lowercase italic h-8 flex items-center">{alergeno.nombre}</span>
                  </button>
                );
              })}
            </div>

            <button
              id="clear-filters"
              class="hidden px-6 py-2 bg-white/5 hover:bg-white/10 text-primary text-xs font-black uppercase tracking-widest rounded-full transition-colors border border-primary/20"
            >
              Mostrar todo
            </button>
          </div>
        </div>
      )}

      {/* Category Navigation - Tabs Style */}
      <nav class="mb-12 sticky top-24 z-30 bg-matte-black/90 backdrop-blur-md py-4 -mx-4 px-4 md:mx-0 md:px-0 border-b border-white/10 md:border-none md:bg-transparent md:static overflow-x-auto">
        <div class="flex flex-nowrap md:flex-wrap justify-start md:justify-center gap-3 min-w-max md:min-w-0 px-2 md:px-0" id="category-nav">
          {sortedMainCategories.map((mainCat, index) => (
            <button
              data-category={mainCat.slug}
              class:list={[
                "category-tab px-6 py-2.5 rounded-full border transition-all text-sm font-bold whitespace-nowrap",
                index === 0 ? "bg-primary border-primary text-white" : "border-white/10 text-white/50 hover:border-primary/50 hover:text-white"
              ]}
            >
              {mainCat.mainName}
            </button>
          ))}
        </div>
      </nav>

      {/* Categories Content */}
      <div id="carta-container" class="min-h-[50vh]">
        {sortedMainCategories.map((mainCat, index) => (
          <section 
            id={mainCat.slug} 
            class:list={[
              "category-section transition-all duration-500",
              index === 0 ? "block animate-fade-in" : "hidden"
            ]}
          >
            {/* Main Category Header - Hidden visually as we have tabs, but kept for semantics/SEO if needed, or we can show it as a title for the section */}
            <div class="mb-12 pb-4 border-b-2 border-white/5 flex flex-col items-center justify-center text-center gap-2">
              <h2 class="text-3xl md:text-5xl font-display font-black text-white uppercase tracking-widest">
                {mainCat.mainName}
              </h2>
              <div class="h-1 w-20 bg-primary/30 rounded-full mt-1"></div>
            </div>

            {/* Subcategories and dishes */}
            {mainCat.subcategories.map((subcat) => {
              const isVisualCategory = ['vinos', 'espumosos-y-vinos-dulces', 'vermut-y-cervezas'].includes(mainCat.slug);
              
              return (
              <div class="mb-12 last:mb-0">
                {/* Subcategory header */}
                {subcat.subcategoryName && (
                  <div class="mb-6">
                    <h3 class="text-xl md:text-2xl font-bold text-white border-b-2 border-primary/50 pb-1 inline-block uppercase tracking-wider mb-2">
                      {subcat.subcategoryName}
                    </h3>
                    {subcat.descripcion && (
                      <p class="text-zinc-500 text-sm mt-1">{subcat.descripcion}</p>
                    )}
                  </div>
                )}

                {/* Dishes list grid */}
                <div class:list={[
                  "grid gap-y-4 gap-x-12",
                  isVisualCategory ? "grid-cols-1" : "grid-cols-1 md:grid-cols-2"
                ]}>
                  {subcat.platos.map((dish: any) => {
                    let dishWithImg = dish;
                    
                    if (isVisualCategory) {
                       const localImg = getLocalImageForDish(dish.nombre, mainCat.slug);
                       if (localImg) {
                         dishWithImg = { ...dish, imagen: { url: localImg } };
                       }
                    }

                    return (
                    <div class="dish-item-wrapper last:border-none">
                      {isVisualCategory ? (
                        <DishCard plato={dishWithImg} />
                      ) : (
                        <DishListItem plato={dish} />
                      )}
                    </div>
                  )})}
                </div>
              </div>
            )})}
          </section>
        ))}
        
        <div id="no-results" class="hidden flex flex-col items-center justify-center py-20 text-center animate-fade-up">
          <span class="material-symbols-outlined text-tx-muted text-5xl mb-4">no_food</span>
          <p class="text-white/60 text-lg">No se han encontrado platos con los filtros seleccionados en esta categoría.</p>
          <button id="clear-filters-msg" class="mt-4 text-primary text-xl font-bold hover:underline">Limpiar filtros</button>
        </div>
      </div>

    </Container>
  </Section>

  <script>
    document.addEventListener('astro:page-load', () => {
      // DOM Elements
      const tabs = document.querySelectorAll('.category-tab');
      const sections = document.querySelectorAll('.category-section');
      const filterBtns = document.querySelectorAll('.allergen-filter-btn');
      const clearBtn = document.getElementById('clear-filters');
      const clearBtnMsg = document.getElementById('clear-filters-msg');
      const dishWrappers = document.querySelectorAll('.dish-item-wrapper');
      const noResults = document.getElementById('no-results');

      // State
      let activeCategory = '';
      let activeFilters = new Set<string>();

      // Initialize
      init();

      function init() {
        // Check hash for initial category
        const hash = window.location.hash.replace('#', '');
        if (hash && document.getElementById(hash)) {
          switchCategory(hash, false);
        } else {
          // Default to first category
          const firstCat = document.querySelector('.category-section')?.id;
          if (firstCat) switchCategory(firstCat, false);
        }

        setupEventListeners();
      }

      function setupEventListeners() {
        // Tab Clicks
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const slug = tab.getAttribute('data-category');
            if (slug) {
              switchCategory(slug, true);
              // Update URL without scroll
              history.replaceState(null, '', `#${slug}`);
            }
          });
        });

        // Allergen Filters
        filterBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-alergeno-id');
            if (!id) return;

            if (activeFilters.has(id)) {
              activeFilters.delete(id);
              btn.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
              btn.classList.add('text-white/40', 'border-white/5');
            } else {
              activeFilters.add(id);
              btn.classList.add('active', 'bg-primary', 'text-white', 'border-primary');
              btn.classList.remove('text-white/40', 'border-white/5');
            }

            updateVisibility();
          });
        });

        // Clear Filters
        const clearAll = () => {
          activeFilters.clear();
          filterBtns.forEach(btn => {
            btn.classList.remove('active', 'bg-primary', 'text-white', 'border-primary');
            btn.classList.add('text-white/40', 'border-white/5');
          });
          updateVisibility();
        };

        clearBtn?.addEventListener('click', clearAll);
        clearBtnMsg?.addEventListener('click', clearAll);
      }

      function switchCategory(slug: string, shouldScroll = false) {
        if (activeCategory === slug) return;
        activeCategory = slug;

        // Update Tabs
        tabs.forEach(tab => {
          const isActive = tab.getAttribute('data-category') === slug;
          if (isActive) {
            tab.classList.remove('border-white/10', 'text-white/50', 'hover:border-primary/50', 'hover:text-white');
            tab.classList.add('bg-primary', 'border-primary', 'text-white');

            // Scroll nav to visible if needed (mobile) - only on user click
            if (shouldScroll) {
              tab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
          } else {
            tab.classList.add('border-white/10', 'text-white/50', 'hover:border-primary/50', 'hover:text-white');
            tab.classList.remove('bg-primary', 'border-primary', 'text-white');
          }
        });

        // Update Categories Visibility
        sections.forEach(section => {
          if (section.id === slug) {
            section.classList.remove('hidden');
            section.classList.add('block', 'animate-fade-in');
          } else {
            section.classList.add('hidden');
            section.classList.remove('block', 'animate-fade-in');
          }
        });

        updateVisibility();
      }

      function updateVisibility() {
        // Check filters logic
        if (activeFilters.size > 0) {
          clearBtn?.classList.remove('hidden');
        } else {
          clearBtn?.classList.add('hidden');
        }

        // We only care about dishes in the ACTIVE category for the "No results" message
        // But we update ALL dishes just in case user switches back
        let visibleInActiveCategory = 0;

        dishWrappers.forEach(wrapper => {
          const card = wrapper.querySelector('.dish-card');
          if (!card) return;

          const cardAlergenos = (card.getAttribute('data-alergenos') || '').split(',').filter(Boolean);
          // Logic: Hide if dish HAS any of the selected blockers (assuming "Filtrar sin")
          const hasBlockedAlergen = Array.from(activeFilters).some(filterId => cardAlergenos.includes(filterId as string));
          
          // Use inline style for reliability over classList
          if (hasBlockedAlergen) {
            wrapper.style.display = 'none';
          } else {
            wrapper.style.display = '';
            
            // Check if this visible dish is in the current category
            const section = wrapper.closest('.category-section');
            if (section && section.id === activeCategory) {
              visibleInActiveCategory++;
            }
          }
        });

        // Show/Hide No Results Message
        if (visibleInActiveCategory === 0 && activeFilters.size > 0) {
          noResults?.classList.remove('hidden');
        } else {
          noResults?.classList.add('hidden');
        }
      }

    });
  </script>

</MainLayout>
