---
import MainLayout from '../layouts/MainLayout.astro';
import Section from '../components/ui/Section.astro';
import Container from '../components/ui/Container.astro';
import MenuCard from '../components/content/MenuCard.astro';
import { getSiteSettings, getMenus, getPaginaBySlug, getMenusGrupo } from '../lib/payload-local';

// Disable caching to always show fresh content from CMS
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

let siteSettings, menus = [], menusGrupo = [], pageData;

try {
  [siteSettings, menus, menusGrupo, pageData] = await Promise.all([
    getSiteSettings(),
    getMenus(),
    getMenusGrupo(),
    getPaginaBySlug('menus')
  ]);
} catch (error) {
  console.error("Error al cargar datos en menus.astro:", error);
}

const pageTitle = pageData?.metaTitle || `Menús | ${siteSettings?.title || "Warynessy"}`;
const pageDescription = pageData?.metaDescription || "Descubre nuestros menús degustación y opciones especiales.";

// Imagen Hero desde el CMS o fallback
const heroImg = typeof pageData?.heroImage === 'object' && pageData?.heroImage?.url 
  ? pageData.heroImage.url 
  : 'https://images.unsplash.com/photo-1544148103-0773bf10d330?auto=format&fit=crop&q=80';

const PAYLOAD_URL = import.meta.env.PAYLOAD_PUBLIC_SERVER_URL || 'http://localhost:3000';
---

<MainLayout title={pageTitle} description={pageDescription} hideFloatingButton={true} noPaddingTop={true}>
    <section class="relative pt-32 pb-12 md:pt-48 md:pb-16 bg-matte-black overflow-hidden">
      <div class="absolute inset-0 bg-cover bg-center opacity-30" style={`background-image: url('${heroImg}')`}></div>
      <div class="absolute inset-0 bg-gradient-to-t from-matte-black via-matte-black/60 to-transparent"></div>
      <Container class="relative z-10 text-center animate-fade-up">
         <span class="text-primary font-black tracking-[0.3em] uppercase text-sm mb-4 block">
            Exclusividad
         </span>
         <h1 class="text-5xl md:text-7xl font-display font-black text-white mb-6 uppercase tracking-tight">
           Selección de Menús
         </h1>
         <p class="text-white/50 text-base md:text-lg max-w-2xl mx-auto font-medium">
           Experiencias culinarias diseñadas para cada momento
         </p>
      </Container>
   </section>

   <Section class="bg-matte-black min-h-screen pt-12 pb-24">
     <Container>
       {/* Sección de Menús de Grupo */}
       {menusGrupo && menusGrupo.length > 0 && (
         <div class="mb-24">
           <div class="flex items-center gap-6 mb-12">
             <h2 class="text-3xl md:text-4xl font-display font-black text-white uppercase tracking-tight shrink-0">Menús de Grupo</h2>
             <div class="h-px bg-white/10 w-full"></div>
           </div>
           
           <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
             {menusGrupo.map((grupo: any) => (
               <div class="bg-surface-dark/50 border border-white/5 rounded-[2.5rem] overflow-hidden group hover:border-primary/30 transition-all duration-500 shadow-2xl">
                 <div class="relative h-64 overflow-hidden">
                    {grupo.imagenPortada && typeof grupo.imagenPortada === 'object' && grupo.imagenPortada.url && (
                      <img 
                        src={grupo.imagenPortada.url.startsWith('/') ? `${PAYLOAD_URL}${grupo.imagenPortada.url}` : grupo.imagenPortada.url} 
                        alt={grupo.nombre}
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                      />
                    )}
                    <div class="absolute inset-0 bg-gradient-to-t from-matte-black via-matte-black/40 to-transparent"></div>
                    <div class="absolute bottom-6 left-8">
                       <h3 class="text-3xl font-display font-black text-white tracking-tight">{grupo.nombre}</h3>
                    </div>
                 </div>
                 
                 <div class="p-8 md:p-10 space-y-8">
                   {grupo.descripcion && (
                     <p class="text-white/60 text-lg font-medium leading-relaxed italic">
                       "{grupo.descripcion}"
                     </p>
                   )}
                   
                   <div class="space-y-4">
                      {grupo.menus?.map((menu: any) => (
                        menu && typeof menu === 'object' && menu.slug ? (
                          <a 
                            href={`/menus/${menu.slug}`} 
                            class="flex items-center justify-between p-5 bg-white/5 rounded-2xl border border-white/5 hover:bg-primary/10 hover:border-primary/20 transition-all group/item"
                          >
                            <div class="flex items-center gap-4">
                              <span class="material-symbols-outlined text-primary text-xl">restaurant_menu</span>
                              <span class="text-white font-bold tracking-tight">{menu.nombre}</span>
                            </div>
                            <div class="flex items-center gap-4">
                              <span class="text-primary font-black font-display">{menu.precio}€</span>
                              <span class="material-symbols-outlined text-white/20 group-hover/item:text-primary group-hover/item:translate-x-1 transition-all">chevron_right</span>
                            </div>
                          </a>
                        ) : null
                      ))}
                   </div>
                 </div>
               </div>
             ))}
           </div>
         </div>
       )}

       {/* Sección de Menús Individuales */}
       <div class="flex items-center gap-6 mb-12">
         <h2 class="text-3xl md:text-4xl font-display font-black text-white uppercase tracking-tight shrink-0">{pageData?.heroTitle || 'Menús Degustación'}</h2>
         <div class="h-px bg-white/10 w-full"></div>
       </div>

       {menus.length > 0 ? (
         <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 max-w-6xl mx-auto">
           {menus.map((menu: any) => (
              <MenuCard menu={menu} />
           ))}
         </div>
       ) : (
         <div class="text-center py-20">
           <p class="text-white/40 text-xl">Próximamente nuevos menús de temporada.</p>
         </div>
       )}
     </Container>
   </Section>
</MainLayout>
