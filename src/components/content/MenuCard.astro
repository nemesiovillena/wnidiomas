---
import { type Menu } from '../../payload/payload-types';
import ResponsiveImage from '../ui/ResponsiveImage.astro';
import Button from '../ui/Button.astro';

interface Props {
  menu: Menu;
}

import { getOptimizedImageUrl } from '../../lib/cdn';

const { menu } = Astro.props;
const imageUrl = getOptimizedImageUrl(typeof menu.imagen === 'object' ? menu.imagen?.url || '' : '');

// Extract plain text from Lexical rich text
function extractText(richText: any): string {
  if (!richText?.root?.children) return '';
  function walk(nodes: any[]): string {
    return nodes.map((node: any) => {
      if (node.type === 'text') return node.text || '';
      if (node.children) return walk(node.children);
      return '';
    }).join(' ');
  }
  return walk(richText.root.children).trim();
}

const descriptionText = menu.descripcion_menu || '';
const descriptionHtml = descriptionText.replace(/\n/g, '<br>');

// Date formatting
const formatDate = (dateString: string, includeYear: boolean = true) => {
  if (!dateString) return '';
  return new Date(dateString).toLocaleDateString('es-ES', {
    day: 'numeric',
    month: 'long',
    ...(includeYear ? { year: 'numeric' } : {})
  });
};

const dateRange = menu.fechaInicio && menu.fechaFin
  ? `Del <strong>${formatDate(menu.fechaInicio, false)}</strong> hasta el <strong>${formatDate(menu.fechaFin)}</strong>`
  : null;

// Badge Logic
const badgeText = menu.etiqueta && menu.etiqueta !== "null" ? menu.etiqueta : (menu.destacado ? 'Destacado' : null);

---

<div class="group flex flex-col bg-surface-dark/40 rounded-[2.5rem] overflow-hidden border border-white/5 hover:border-primary/20 transition-all duration-500 hover:shadow-2xl hover:shadow-primary/5">
  {/* Image Section */}
  <div class="relative aspect-[16/10] overflow-hidden m-2 rounded-[2rem]">
    {imageUrl && (
      <img
        src={imageUrl}
        alt={menu.nombre}
        class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-110"
      />
    )}
    <div class="absolute inset-0 bg-black/10"></div>
  </div>

  {/* Content Section */}
  <div class="p-8 pt-4 flex flex-col gap-4">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-baseline gap-1 flex-shrink-0">
        <span class="text-3xl font-black text-primary font-display">{menu.precio}€</span>
        <span class="text-sm sm:text-xs text-white/40 uppercase tracking-widest font-bold">/ persona</span>
      </div>
      
      {/* Dynamic Badge */}
      {badgeText && (
        <span class="px-3 py-1 bg-primary text-white text-[10px] uppercase tracking-widest font-black rounded-md shadow-lg shadow-primary/20 flex-shrink-0 text-center">
          {badgeText}
        </span>
      )}
    </div>

    <div class="flex flex-col gap-2">
      <h3 class="text-2xl md:text-3xl font-display font-black text-white leading-tight">
        {menu.nombre}
      </h3>
      
      {descriptionText && (
        <p class="text-white/50 text-base sm:text-sm leading-relaxed font-medium mt-1" set:html={descriptionHtml} />
      )}

      <div class="flex flex-col gap-1 mt-2">
        {menu.fechasDias && (
          <p class="text-white/60 text-base sm:text-sm font-bold italic">
            {menu.fechasDias}
          </p>
        )}

        {dateRange && (
          <p class="text-white/60 text-base sm:text-sm font-medium" set:html={dateRange}></p>
        )}
      </div>
    </div>

    <div class="mt-4">
      <a 
        href={`/menus/${menu.slug}`} 
        class="flex items-center justify-center w-full py-4 bg-primary text-white rounded-2xl text-sm font-black uppercase tracking-[0.2em] transition-all hover:bg-primary/80 active:scale-[0.98] shadow-lg shadow-primary/20"
        data-track="menu_view"
        data-track-category="menu_card"
      >
        Ver menú
      </a>
    </div>
  </div>
</div>
