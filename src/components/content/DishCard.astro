---
import { type Plato } from '../../payload-types';
import ResponsiveImage from '../ui/ResponsiveImage.astro';

interface Props {
  plato: Plato;
}

const { plato } = Astro.props;

// Helper to get image URL
const imageUrl = typeof plato.imagen === 'object' && plato.imagen?.url ? plato.imagen.url : '';
---

<div class="group relative flex flex-col gap-4 border-b border-dotted border-zinc-300 pb-8 mb-8 last:border-0 last:pb-0 last:mb-0"
  data-alergenos={plato.alergenos?.map((a: any) => typeof a === 'object' ? a.id : a).join(',')}
>
  <!-- Main Header: Horizontal on desktop, vertical on mobile -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 md:gap-8">
    
    <!-- Image: Large on mobile centered, left on desktop -->
    {imageUrl && (
      <div class="w-full md:w-96 shrink-0 flex items-center justify-center md:justify-start">
        <img 
          src={imageUrl} 
          alt={plato.nombre}
          class="w-[85%] md:w-full h-auto object-contain max-h-64 md:max-h-80" 
          loading="lazy"
        />
      </div>
    )}

    <!-- Name & Price Group: Row on mobile, split on desktop -->
    <div class="flex flex-row items-center justify-between gap-4 w-full md:contents">
      <!-- Name -->
      <div class="flex-grow text-left">
        <h3 class="font-display text-lg md:text-xl font-medium text-zinc-800">
          {plato.nombre}
        </h3>
      </div>

      <!-- Price -->
      <div class="shrink-0">
        <span class="inline-block px-4 py-2 bg-zinc-100 text-zinc-900 font-medium text-sm md:text-base rounded-md whitespace-nowrap">
          {plato.precio.toLocaleString('es-ES', { minimumFractionDigits: 2 })} â‚¬
        </span>
      </div>
    </div>
  </div>

  <!-- Description Section: Always below the main header -->
  <div class="flex flex-col gap-2">
    {plato.descripcion && (
      <div class="mt-1">
        <p class="text-sm md:text-base text-zinc-500 italic leading-relaxed">
          {plato.descripcion}
        </p>
      </div>
    )}

    <!-- Allergen tags -->
    {plato.alergenos && plato.alergenos.length > 0 && (
      <div class="flex gap-2 flex-wrap mt-2">
        {plato.alergenos.map((alergeno: any) => {
          const PAYLOAD_URL = import.meta.env.PAYLOAD_PUBLIC_SERVER_URL || 'http://localhost:3000';
          const imgUrl = typeof alergeno.imagen === 'object' && alergeno.imagen?.url 
            ? (alergeno.imagen.url.startsWith('/') ? `${PAYLOAD_URL}${alergeno.imagen.url}` : alergeno.imagen.url)
            : null;
            
          return (
            <span 
              class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-zinc-100 text-[10px] text-zinc-500 overflow-hidden"
              title={alergeno.nombre}
            >
              {imgUrl ? (
                <img src={imgUrl} alt={alergeno.nombre} class="w-full h-full object-contain p-1 opacity-60" />
              ) : (
                alergeno.icono || alergeno.codigo
              )}
            </span>
          );
        })}
      </div>
    )}
  </div>
</div>
