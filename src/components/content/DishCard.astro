---
import { type Plato } from '../../payload-types';
import { getOptimizedImageUrl } from '../../lib/cdn';

interface Props {
  plato: Plato;
}

const { plato } = Astro.props;

// Helper to get image URL - skip CDN for local static images
const rawImageUrl = typeof plato.imagen === 'object' && plato.imagen?.url ? plato.imagen.url : '';
const imageUrl = rawImageUrl.startsWith('/images/') ? rawImageUrl : (rawImageUrl ? getOptimizedImageUrl(rawImageUrl) : '');
---

<div class="dish-card group relative flex flex-col gap-4 border-b border-white/5 pb-8 mb-8 hover:bg-white/5 -mx-4 md:-mx-6 px-4 md:px-6 py-8 rounded-3xl transition-all duration-300 cursor-default"
  data-alergenos={plato.alergenos?.map((a: any) => typeof a === 'object' ? a.id : a).join(',')}
>
  <!-- Main Header: Horizontal on desktop, vertical on mobile -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 md:gap-8">
    
    <!-- Image: Large on mobile centered, left on desktop -->
    {imageUrl && (
      <div class="w-full md:w-96 shrink-0 flex items-center justify-center md:justify-start">
        <img
          src={imageUrl}
          alt={plato.nombre}
          class="w-full h-auto object-contain max-h-80 md:max-h-80"
          loading="lazy"
        />
      </div>
    )}

    <!-- Name & Price Group: Row on mobile, split on desktop -->
    <div class="flex flex-row items-center justify-between gap-4 w-full md:contents">
      <!-- Name -->
      <div class="flex-grow text-left flex flex-col gap-1">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-2 flex-wrap">
            <h3 class="font-display text-lg md:text-xl font-medium text-white">
              {plato.nombre}
            </h3>
            {plato.destacado && (
              <span class="px-2 py-0.5 bg-primary/20 border border-primary/30 text-primary text-[10px] uppercase tracking-widest font-black rounded-md">
                ⭐ Recomendado
              </span>
            )}
          </div>
          {plato.etiquetas && plato.etiquetas.length > 0 && (
            <div class="flex gap-2">
              {plato.etiquetas.map((item) => (
                <span class="px-2 py-0.5 bg-primary/20 border border-primary/30 text-primary text-[10px] uppercase tracking-widest font-black rounded-md shadow-sm flex-shrink-0 text-center">
                  {item.etiqueta}
                </span>
              ))}
            </div>
          )}
        </div>
        {plato.alergenos && plato.alergenos.length > 0 && (
          <div class="flex gap-2 flex-wrap">
            {plato.alergenos.map((alergeno: any) => {
              const imgUrl = typeof alergeno.imagen === 'object' && alergeno.imagen?.url
                ? getOptimizedImageUrl(alergeno.imagen.url)
                : null;

              return (
                <div class="flex flex-col items-center gap-1 group/alergeno">
                  <span
                    class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-white/5 text-xs text-white/40 overflow-hidden transition-transform group-hover/alergeno:scale-110"
                    title={alergeno.nombre}
                  >
                    {imgUrl ? (
                      <img src={imgUrl} alt={alergeno.nombre} class="w-full h-full object-contain invert opacity-60 group-hover:opacity-100" />
                    ) : (
                      alergeno.icono || alergeno.codigo
                    )}
                  </span>
                  <span class="text-[10px] text-zinc-400 font-medium lowercase italic tracking-tighter text-center leading-none max-w-[56px] line-clamp-2">
                    {alergeno.nombre}
                  </span>
                </div>
              );
            })}
          </div>
        )}
        {plato.descripcion && (
          <p class="text-sm md:text-base text-zinc-400 italic leading-relaxed">
            {plato.descripcion}
          </p>
        )}
      </div>

      <!-- Price -->
      <div class="shrink-0">
        <span class="inline-block px-4 py-2 bg-white/5 text-white font-medium text-sm md:text-base rounded-md whitespace-nowrap">
          {plato.precio.toLocaleString('es-ES', { minimumFractionDigits: 2 })} €
        </span>
      </div>
    </div>
  </div>

  </div>
