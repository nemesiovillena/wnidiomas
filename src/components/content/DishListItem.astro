---
import { type Plato } from '../../payload-types';
import { getOptimizedImageUrl } from '../../lib/cdn';

interface Props {
  plato: Plato;
}

const { plato } = Astro.props;
---

<div
  class="dish-card group flex items-start justify-between py-3 border-b border-white/5 hover:bg-white/5 -mx-4 px-4 transition-colors"
  data-alergenos={plato.alergenos?.map((a: any) => typeof a === 'object' ? a.id : a).join(',')}
>
  <div class="flex-1 pr-4">
    <div class="flex items-center gap-2 flex-wrap">
      <h3 class="font-display text-base font-medium text-white transition-colors">
        {plato.nombre}
      </h3>
      {plato.destacado && (
        <span class="px-2 py-0.5 bg-primary/20 border border-primary/30 text-primary text-[9px] uppercase tracking-widest font-black rounded-md">
          Recomendado esta semana
        </span>
      )}
      {plato.etiquetas && plato.etiquetas.length > 0 && plato.etiquetas.map((item: any) => (
        <span class="px-2 py-0.5 bg-white/10 border border-white/20 text-white/70 text-[9px] uppercase tracking-widest font-bold rounded-md">
          {item.etiqueta}
        </span>
      ))}
    </div>
    {plato.alergenos && plato.alergenos.length > 0 && (
      <div class="flex gap-2 mt-1 flex-wrap">
            {plato.alergenos.map((alergeno: any) => {
              const imgUrl = typeof alergeno.imagen === 'object' && alergeno.imagen?.url
                ? getOptimizedImageUrl(alergeno.imagen.url)
                : null;

          return (
            <div class="flex flex-col items-center gap-1 group/alergeno">
            <span
              class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/5 text-xs text-white/40 overflow-hidden transition-transform group-hover/alergeno:scale-110"
                title={alergeno.nombre}
              >
                {imgUrl ? (
                  <img src={imgUrl} alt={alergeno.nombre} class="w-full h-full object-contain" />
                ) : (
                  alergeno.icono || alergeno.codigo
                )}
              </span>
              <span class="text-[10px] text-zinc-400 font-medium lowercase italic tracking-tighter text-center leading-none max-w-[48px] line-clamp-2">
                {alergeno.nombre}
              </span>
            </div>
          );
        })}
      </div>
    )}
    {plato.descripcion && (
      <span class="text-sm text-zinc-500 italic block mt-1">
        {plato.descripcion}
      </span>
    )}
  </div>
  {plato.precio && plato.precio !== '0' && (
    <span class="inline-block px-6 py-3 bg-white/5 text-white font-medium text-base rounded-xl tabular-nums whitespace-nowrap">
      {plato.precio} â‚¬
    </span>
  )}
</div>
